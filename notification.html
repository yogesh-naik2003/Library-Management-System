<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Library Notifications</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    body {
      background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
      font-family: 'Poppins', Arial, sans-serif;
      min-height: 100vh;
      margin: 0;
      color: #222;
    }
    .notif-header {
      background: linear-gradient(90deg, #4e73df 0%, #224abe 100%);
      color: #fff;
      padding: 2rem 0 1rem 0;
      border-bottom-left-radius: 32px;
      border-bottom-right-radius: 32px;
      box-shadow: 0 8px 32px rgba(78, 115, 223, 0.15);
      text-align: center;
      margin-bottom: 2rem;
    }
    .notif-header h1 {
      font-size: 2.2rem;
      font-weight: 700;
      letter-spacing: 1px;
      margin-bottom: 0.5rem;
    }
    .notif-header p {
      font-size: 1.1rem;
      opacity: 0.95;
      margin-bottom: 0;
    }
    .notif-section {
      max-width: 1000px;
      margin: 0 auto;
      padding: 2.5rem 2rem;
      background: rgba(255,255,255,0.92);
      border-radius: 32px;
      box-shadow: 0 12px 40px rgba(78, 115, 223, 0.13);
      border: 1px solid rgba(78, 115, 223, 0.10);
    }
    .notif-title {
      font-weight: 700;
      color: #224abe;
      margin-bottom: 1.2rem;
      letter-spacing: 0.5px;
      text-align: center;
    }
    .notif-card {
      background: linear-gradient(120deg, #f6f9ff 80%, #e0eafc 100%);
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(78, 115, 223, 0.10);
      border: none;
      margin-bottom: 2.2rem;
      padding: 2.2rem 2.2rem;
      display: flex;
      align-items: flex-start;
      gap: 2rem;
      transition: box-shadow 0.2s, background 0.2s;
      position: relative;
      min-height: 140px;
    }
    .notif-card:hover {
      box-shadow: 0 12px 48px rgba(78, 115, 223, 0.18);
      background: #f6f9ff;
    }
    .notif-icon {
      font-size: 2.7rem;
      color: #4e73df;
      flex-shrink: 0;
      margin-top: 0.2rem;
      min-width: 64px;
      min-height: 64px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .notif-content {
      flex: 1;
    }
    .notif-title-main {
      font-size: 1.15rem;
      font-weight: 600;
      color: #224abe;
      margin-bottom: 0.2rem;
    }
    .notif-date {
      font-size: 0.98rem;
      color: #6c757d;
      margin-bottom: 0.5rem;
      font-style: italic;
    }
    .notif-desc {
      font-size: 1.05rem;
      color: #333;
      margin-bottom: 0;
    }
    @media (max-width: 900px) {
      .notif-section { max-width: 98vw; padding: 1.2rem 0.5rem; }
      .notif-card { padding: 1.2rem 0.7rem; gap: 1rem; }
    }
    @media (max-width: 600px) {
      .notif-section { padding: 1rem 0.3rem; }
      .notif-header h1 { font-size: 1.3rem; }
      .notif-header p { font-size: 1rem; }
      .notif-card { flex-direction: column; gap: 0.7rem; padding: 1rem 0.7rem; min-height: unset; }
      .notif-icon { font-size: 1.5rem; min-width: 36px; min-height: 36px; }
    }
  </style>
</head>
<body>
  <div class="notif-header">
    <h1><i class="fas fa-bell me-2"></i>Library Notifications</h1>
    <p>Stay updated with the latest library events and announcements!</p>
  </div>
  <div class="notif-section">
    <h3 class="notif-title"><i class="fas fa-calendar-alt me-2"></i>Event Announcements</h3>
    <div class="mb-3 d-flex flex-wrap gap-2 justify-content-center">
      <button class="btn btn-outline-primary btn-sm" id="filter-all" type="button">All Notifications</button>
      <button class="btn btn-outline-success btn-sm" id="filter-events" type="button">Events</button>
      <button class="btn btn-outline-warning btn-sm" id="filter-newarrivals" type="button">New Arrivals</button>
      <button class="btn btn-outline-info btn-sm" id="filter-borrowed" type="button">Borrowed Books</button>
      <button class="btn btn-outline-secondary btn-sm" id="filter-returned" type="button">Returned Books</button>
    </div>
    <div id="notifEvents"></div>
    <hr class="my-4">
    <h3 class="notif-title"><i class="fas fa-book-reader me-2"></i>Borrowed & Returned Books</h3>
    <div id="notifBooks"></div>
  </div>
  <script>
    let allEventHtml = '';
    let allBorrowedHtml = '';
    let allReturnedHtml = '';
    let allRecommendedHtml = '';
    let allNewArrivalsHtml = '';

    // Track current filter
    let currentFilter = 'all';

    async function loadAllNotifications() {
      // Load all notification types in parallel
      await Promise.all([
        loadEventNotifications(),
        loadRecommendedNotifications(),
        loadNewArrivalsNotifications()
      ]);
      updateNotifEventsByCurrentFilter();
    }

    async function loadEventNotifications() {
      try {
        const res = await fetch('http://127.0.0.1:5000/events');
        const events = await res.json();
        if (!Array.isArray(events) || !events.length) {
          allEventHtml = '';
          return;
        }
        // Show latest first, limit to 12
        const sortedEvents = events.slice().reverse().slice(0, 12);
        allEventHtml = sortedEvents.map(ev => `
          <div class="notif-card" style="background: linear-gradient(120deg, #f8fafc 80%, #e3f0ff 100%); border-left: 7px solid #4e73df; box-shadow: 0 6px 24px rgba(78,115,223,0.13); display: flex; align-items: center; gap: 1.5rem; padding: 2.2rem 2.2rem;">
            <div class="notif-icon" style="background: #4e73df; color: #fff; border-radius: 50%; width: 64px; height: 64px; display: flex; align-items: center; justify-content: center; font-size: 2.2rem; box-shadow: 0 2px 8px #4e73df33;">
              <i class="fas fa-bullhorn"></i>
            </div>
            <div class="notif-content">
              <div class="notif-title-main" style="font-size:1.22rem; font-weight:700; color:#224abe; margin-bottom:0.25rem;">
                "Don't miss this amazing opportunity!" <b>${ev.title}</b>
              </div>
              <div class="notif-desc" style="font-size:1.08rem; color:#333; margin-bottom:0;">
                Check it now!<br>
                <span style="color:#d63384;font-weight:600;">Don't miss!!</span>
              </div>
              <div class="notif-date" style="font-size:1.01rem; color:#4e73df; margin-top:0.7rem; font-style:italic;">
                <i class="far fa-calendar-alt me-1"></i>${ev.event_date}
                ${ev.event_time ? `&nbsp; <i class="far fa-clock me-1"></i>${ev.event_time}` : ''}
              </div>
            </div>
          </div>
        `).join('');
      } catch (e) {
        allEventHtml = '';
      }
    }

    async function loadRecommendedNotifications() {
      const books = JSON.parse(localStorage.getItem('recommendedBooks')) || [];
      if (!Array.isArray(books) || !books.length) {
        allRecommendedHtml = '';
        return;
      }
      // Show latest first, limit to 12
      const sortedBooks = books.slice().reverse().slice(0, 12);
      allRecommendedHtml = sortedBooks.map(book => `
        <div class="notif-card" style="background: linear-gradient(120deg, #fffde7 80%, #ffe082 100%); border-left: 7px solid #ffb300; box-shadow: 0 6px 24px rgba(255,179,0,0.13); display: flex; align-items: center; gap: 1.5rem; padding: 2.2rem 2.2rem;">
          <div class="notif-icon" style="background: #ffb300; color: #fff; border-radius: 50%; width: 64px; height: 64px; display: flex; align-items: center; justify-content: center; font-size: 2.2rem; box-shadow: 0 2px 8px #ffb30033;">
            <i class="fas fa-star"></i>
          </div>
          <div class="notif-content">
            <div class="notif-title-main" style="font-size:1.18rem; font-weight:700; color:#b28704; margin-bottom:0.25rem;">
              "A new gem has been added to your recommendations!"
            </div>
            <div class="notif-desc" style="font-size:1.08rem; color:#333; margin-bottom:0;">
              <b>${book.book_name}</b><br>
              <span style="color:#ff7043;font-weight:600;">Check it now!!</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    async function loadNewArrivalsNotifications() {
      const books = JSON.parse(localStorage.getItem('newArrivals')) || [];
      if (!Array.isArray(books) || !books.length) {
        allNewArrivalsHtml = '';
        return;
      }
      // Show latest first, limit to 12
      const sortedBooks = books.slice().reverse().slice(0, 12);
      allNewArrivalsHtml = sortedBooks.map(book => `
        <div class="notif-card" style="background: linear-gradient(120deg, #e3ffe7 80%, #b2ffb2 100%); border-left: 7px solid #28a745; box-shadow: 0 6px 24px rgba(40,167,69,0.13); display: flex; align-items: center; gap: 1.5rem; padding: 2.2rem 2.2rem;">
          <div class="notif-icon" style="background: #28a745; color: #fff; border-radius: 50%; width: 64px; height: 64px; display: flex; align-items: center; justify-content: center; font-size: 2.2rem; box-shadow: 0 2px 8px #28a74533;">
            <i class="fas fa-book-open"></i>
          </div>
          <div class="notif-content">
            <div class="notif-title-main" style="font-size:1.18rem; font-weight:700; color:#218838; margin-bottom:0.25rem;">
              "A new arrival is here!"
            </div>
            <div class="notif-desc" style="font-size:1.08rem; color:#333; margin-bottom:0;">
              <b>${book.book_name}</b><br>
              <span style="color:#218838;font-weight:600;">Check it now!!</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    async function showNewArrivalsNotifications() {
      document.getElementById('notifEvents').style.display = '';
      document.getElementById('notifBooks').style.display = 'none';
      document.getElementById('filter-all').classList.remove('active');
      document.getElementById('filter-events').classList.remove('active');
      document.getElementById('filter-newarrivals').classList.add('active');
      document.getElementById('filter-borrowed').classList.remove('active');
      document.getElementById('filter-returned').classList.remove('active');
      currentFilter = 'newarrivals';
      await loadNewArrivalsNotifications();
      document.getElementById('notifEvents').innerHTML = allNewArrivalsHtml || '<div class="alert alert-info">No new arrivals yet.</div>';
    }

    function loadBookNotifications() {
      const borrowedBooks = JSON.parse(localStorage.getItem('borrowedBooks')) || [];
      const returnedBooks = JSON.parse(localStorage.getItem('returnedBooks')) || [];
      const container = document.getElementById('notifBooks');
      let html = '';
      allBorrowedHtml = '';
      allReturnedHtml = '';

      // Show latest first, limit to 12 for each
      const sortedBorrowed = borrowedBooks.slice().reverse().slice(0, 12);
      const sortedReturned = returnedBooks.slice().reverse().slice(0, 12);

      if (!sortedBorrowed.length && !sortedReturned.length) {
        html = '<div class="alert alert-info">No borrowed or returned book notifications yet.</div>';
      } else {
        // Borrowed notifications
        allBorrowedHtml = sortedBorrowed.map(book => `
          <div class="notif-card" style="background: linear-gradient(120deg, #e0f7fa 80%, #b2ebf2 100%); border-left: 7px solid #1cc88a; box-shadow: 0 6px 24px rgba(28,200,138,0.10); display: flex; align-items: center; gap: 1.5rem; padding: 1.3rem 1.1rem;">
            <div class="notif-icon" style="background: #1cc88a; color: #fff; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
              <i class="fas fa-book"></i>
            </div>
            <div class="notif-content">
              <div class="notif-title-main" style="font-size:1.08rem; font-weight:600; color:#198754; margin-bottom:0.18rem;">
                You have borrowed '<span style="color:#224abe;">${book.book_name}</span>' book
              </div>
              <div class="notif-date" style="font-size:0.98rem; color:#198754; font-style:italic;">
                <i class="far fa-calendar-check me-1"></i>${book.borrowed_date ? book.borrowed_date : ''}
              </div>
            </div>
          </div>
        `).join('');
        // Returned notifications
        allReturnedHtml = sortedReturned.map(book => `
          <div class="notif-card" style="background: linear-gradient(120deg, #f3e5f5 80%, #ede7f6 100%); border-left: 7px solid #6f42c1; box-shadow: 0 6px 24px rgba(111,66,193,0.10); display: flex; align-items: center; gap: 1.5rem; padding: 1.3rem 1.1rem;">
            <div class="notif-icon" style="background: #6f42c1; color: #fff; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
              <i class="fas fa-undo"></i>
            </div>
            <div class="notif-content">
              <div class="notif-title-main" style="font-size:1.08rem; font-weight:600; color:#6f42c1; margin-bottom:0.18rem;">
                You have returned '<span style="color:#224abe;">${book.book_name}</span>' book
              </div>
              <div class="notif-date" style="font-size:0.98rem; color:#6f42c1; font-style:italic;">
                <i class="far fa-calendar-check me-1"></i>${book.returned_date ? book.returned_date : ''}
              </div>
            </div>
          </div>
        `).join('');
        html = allBorrowedHtml + allReturnedHtml;
      }
      container.innerHTML = html;
    }

    function updateNotifEventsByCurrentFilter() {
      const notifEvents = document.getElementById('notifEvents');
      if (currentFilter === 'all') {
        notifEvents.innerHTML = allEventHtml + allRecommendedHtml + allNewArrivalsHtml;
      } else if (currentFilter === 'events') {
        notifEvents.innerHTML = allEventHtml;
      } else if (currentFilter === 'newarrivals') {
        notifEvents.innerHTML = allNewArrivalsHtml || '<div class="alert alert-info">No new arrivals yet.</div>';
      }
    }

    // Filter logic
    function showAllNotifications() {
      document.getElementById('notifEvents').style.display = '';
      document.getElementById('notifBooks').style.display = '';
      document.getElementById('filter-all').classList.add('active');
      document.getElementById('filter-events').classList.remove('active');
      document.getElementById('filter-newarrivals').classList.remove('active');
      document.getElementById('filter-borrowed').classList.remove('active');
      document.getElementById('filter-returned').classList.remove('active');
      currentFilter = 'all';
      updateNotifEventsByCurrentFilter();
    }
    function showEventNotifications() {
      document.getElementById('notifEvents').style.display = '';
      document.getElementById('notifBooks').style.display = 'none';
      document.getElementById('filter-all').classList.remove('active');
      document.getElementById('filter-events').classList.add('active');
      document.getElementById('filter-newarrivals').classList.remove('active');
      document.getElementById('filter-borrowed').classList.remove('active');
      document.getElementById('filter-returned').classList.remove('active');
      currentFilter = 'events';
      updateNotifEventsByCurrentFilter();
    }
    document.getElementById('filter-newarrivals').onclick = showNewArrivalsNotifications;
    function showBorrowedNotifications() {
      document.getElementById('notifEvents').style.display = 'none';
      document.getElementById('notifBooks').style.display = '';
      document.getElementById('notifBooks').innerHTML = allBorrowedHtml || '<div class="alert alert-info">No borrowed book notifications yet.</div>';
      document.getElementById('filter-all').classList.remove('active');
      document.getElementById('filter-events').classList.remove('active');
      document.getElementById('filter-newarrivals').classList.remove('active');
      document.getElementById('filter-borrowed').classList.add('active');
      document.getElementById('filter-returned').classList.remove('active');
    }
    function showReturnedNotifications() {
      document.getElementById('notifEvents').style.display = 'none';
      document.getElementById('notifBooks').style.display = '';
      document.getElementById('notifBooks').innerHTML = allReturnedHtml || '<div class="alert alert-info">No returned book notifications yet.</div>';
      document.getElementById('filter-all').classList.remove('active');
      document.getElementById('filter-events').classList.remove('active');
      document.getElementById('filter-newarrivals').classList.remove('active');
      document.getElementById('filter-borrowed').classList.remove('active');
      document.getElementById('filter-returned').classList.add('active');
    }

    document.getElementById('filter-all').onclick = async function() {
      await loadAllNotifications();
      showAllNotifications();
    };
    document.getElementById('filter-events').onclick = async function() {
      await loadAllNotifications();
      showEventNotifications();
    };
    document.getElementById('filter-borrowed').onclick = showBorrowedNotifications;
    document.getElementById('filter-returned').onclick = showReturnedNotifications;

    // Load on page load
    (async function() {
      await loadAllNotifications();
      loadBookNotifications();
      showAllNotifications();
    })();
  </script>
</body>
</html>
