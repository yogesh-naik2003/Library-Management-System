<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin - View Reviews</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --primary-color: #5e72e4; /* Indigo */
      --secondary-color: #6c757d;
      --background-light: linear-gradient(120deg, #f6f9fc 0%, #e9ecef 100%);
      --background-dark: linear-gradient(120deg, #172b4d 0%, #2d3748 100%);
      --card-bg-light: rgba(255, 255, 255, 0.9);
      --card-bg-dark: rgba(45, 55, 72, 0.85); /* Dark blue-gray */
      --text-light: #333;
      --text-dark: #e9ecef;
      --border-light: rgba(0, 0, 0, 0.08);
      --border-dark: rgba(255, 255, 255, 0.15);
      --shadow-light: 0 7px 25px rgba(0, 0, 0, 0.08);
      --shadow-dark: 0 7px 25px rgba(0, 0, 0, 0.3);
      --input-bg-light: #fff;
      --input-bg-dark: #2b354a;
    }

    body {
  font-family: 'Poppins', sans-serif;
  background: url('https://tse4.mm.bing.net/th?id=OIP.a9pQVJEEcYXKA_qTBxS1tAHaEK&pid=Api&P=0&h=180') no-repeat center center fixed, var(--background-light);
  background-size: cover;
  color: var(--text-light);
  min-height: 100vh;
}

    .container {
      max-width: 900px; /* Wider container for admin view */
      margin: auto;
      position: relative;
      z-index: 1;
    }

    body.dark-mode {
  background: url('https://tse1.mm.bing.net/th?id=OIP.ZUi_gd5_pUTOjvwV-nRLNgHaEK&pid=Api&P=0&h=180') no-repeat center center fixed, var(--background-dark);
  background-size: cover;
  color: var(--text-dark);
}

    h2 {
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 30px;
      text-align: center;
      padding-top: 20px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    body.dark-mode h2 {
        color: #ebf1f7; /* Lighter text for dark mode */
    }

    .review-card {
      background: var(--card-bg-light);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      border-radius: 10px;
      box-shadow: var(--shadow-light);
      border: 1px solid var(--border-light);
      padding: 20px;
      margin-bottom: 20px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      opacity: 0; /* Start hidden for animation */
      animation: fadeIn 0.5s ease forwards;
      animation-delay: calc(var(--card-index, 0) * 0.05s); /* Stagger animation */
      position: relative; /* For potential absolute elements like delete */
    }

    .review-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
    }

    body.dark-mode .review-card {
        background: var(--card-bg-dark);
        border-color: var(--border-dark);
        box-shadow: var(--shadow-dark);
    }
    body.dark-mode .review-card:hover {
        box-shadow: 0 6px 20px rgb(199, 192, 192);
    }

    .book-meta {
      font-size: 0.9rem;
      color: var(--secondary-color);
      margin-bottom: 5px;
    }
    body.dark-mode .book-meta {
        color: #809dbe;
    }

    .review-card h6 {
      font-weight: 600;
      color: #343a40;
      margin-bottom: 5px;
    }
    body.dark-mode .review-card h6 {
        color: var(--text-dark);
    }

    .review-card p {
        line-height: 1.6;
        margin-bottom: 10px;
        font-size: 0.95rem;
    }

    .review-card small.text-muted {
      font-style: italic;
      font-size: 0.8rem;
      color: #6c757d !important;
    }
    body.dark-mode .review-card small.text-muted {
        color: #8898aa !important;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Controls Styling */
    .controls-section {
        background: var(--card-bg-light);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        box-shadow: var(--shadow-light);
        border: 1px solid var(--border-light);
    }
    body.dark-mode .controls-section {
        background: var(--card-bg-dark);
        border-color: var(--border-dark);
        box-shadow: var(--shadow-dark);
    }

    .form-control, .form-select {
        background-color: var(--input-bg-light);
        color: var(--text-light);
        border-color: var(--border-light);
    }
    .form-control::placeholder {
        color: #aaa;
    }
    body.dark-mode .form-control, body.dark-mode .form-select {
        background-color: var(--input-bg-dark);
        color: var(--text-dark);
        border-color: var(--border-dark);
    }
    body.dark-mode .form-control::placeholder {
        color: #777;
    }
    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(94, 114, 228, 0.25);
        background-color: var(--input-bg-light); /* Maintain bg on focus */
        color: var(--text-light);
    }
    body.dark-mode .form-control:focus, body.dark-mode .form-select:focus {
        background-color: var(--input-bg-dark);
        color: var(--text-dark);
    }

    /* Dark Mode Toggle */
    .dark-mode-toggle {
        position: absolute;
        top: 15px;
        right: 15px;
        z-index: 10;
    }

  </style>
</head>
<body>

<div class="container py-4">
  <h2>üìù Submitted Book Reviews</h2>

  <!-- Dark Mode Toggle -->
  <div class="form-check form-switch dark-mode-toggle">
    <input class="form-check-input" type="checkbox" role="switch" id="darkModeSwitchAdmin">
    <label class="form-check-label" for="darkModeSwitchAdmin">üåô DarkMode</label>
  </div>

  <!-- Controls: Filter & Sort -->
  <div class="controls-section">
    <div class="row g-3 align-items-center">
      <div class="col-md-6">
        <input type="text" id="filterInput" class="form-control form-control-sm" placeholder="Filter by title, author, user...">
      </div>
      <div class="col-md-4">
        <select id="sortSelect" class="form-select form-select-sm">
          <option value="date_desc">Sort by: Newest First</option>
          <option value="date_asc">Sort by: Oldest First</option>
          <option value="rating_desc">Sort by: Rating (High-Low)</option>
          <option value="rating_asc">Sort by: Rating (Low-High)</option>
        </select>
      </div>
      <div class="col-md-2 text-end">
        <span id="reviewCount" class="badge bg-secondary">0 Reviews</span>
      </div>
    </div>
  </div>

  <div id="adminReviewsContainer">
    <!-- Reviews will be loaded here -->
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading reviews...</p>
    </div>
  </div>
</div>

<script>
  const reviewsContainer = document.getElementById("adminReviewsContainer");
  const filterInput = document.getElementById("filterInput");
  const sortSelect = document.getElementById("sortSelect");
  const reviewCountBadge = document.getElementById("reviewCount");
  const darkModeSwitch = document.getElementById('darkModeSwitchAdmin');

  let allReviews = []; // Store all fetched reviews

  // --- Dark Mode ---
  darkModeSwitch.addEventListener('change', () => {
    document.body.classList.toggle('dark-mode');
    // Optional: Save preference in localStorage
    localStorage.setItem('adminDarkMode', darkModeSwitch.checked);
  });

  // Check localStorage for saved preference
  if (localStorage.getItem('adminDarkMode') === 'true') {
    darkModeSwitch.checked = true;
    document.body.classList.add('dark-mode');
  }

  // --- Display Logic ---
  function displayReviews(reviewsToDisplay) {
    reviewsContainer.innerHTML = ""; // Clear previous content

    if (!reviewsToDisplay || reviewsToDisplay.length === 0) {
        reviewsContainer.innerHTML = '<p class="text-center py-4">No reviews match your criteria.</p>';
        reviewCountBadge.textContent = `0 Reviews`;
        return;
    }

    reviewsToDisplay.forEach((review, index) => {
      const reviewDate = new Date(review.created_at).toLocaleString();
      const reviewCard = document.createElement('div');
      reviewCard.className = 'review-card mb-3';
      reviewCard.style.setProperty('--card-index', index); // For animation delay
      reviewCard.innerHTML = `
          <h6>${review.username} <small class="text-muted">(${review.usn})</small></h6>
          <div class="book-meta"><strong>${review.book_title}</strong> by ${review.author}</div>
          <div class="mb-2">${'‚≠ê'.repeat(review.rating)}</div>
          <p>${review.review_text}</p>
          <small class="text-muted">Reviewed on: ${reviewDate}</small>
          <!-- <button class="btn btn-sm btn-danger delete-btn position-absolute top-0 end-0 m-2" style="--bs-btn-padding-y: .2rem; --bs-btn-padding-x: .4rem; --bs-btn-font-size: .75rem;" onclick="deleteReview(${review.id})">X</button> -->
      `;
      reviewsContainer.appendChild(reviewCard);
    });

    reviewCountBadge.textContent = `${reviewsToDisplay.length} Review${reviewsToDisplay.length !== 1 ? 's' : ''}`;
  }

  // --- Filtering and Sorting ---
  function filterAndSortReviews() {
    const filterText = filterInput.value.toLowerCase();
    const sortBy = sortSelect.value;

    let filtered = allReviews.filter(review =>
        review.book_title.toLowerCase().includes(filterText) ||
        review.author.toLowerCase().includes(filterText) ||
        review.username.toLowerCase().includes(filterText) ||
        review.usn.toLowerCase().includes(filterText) ||
        review.review_text.toLowerCase().includes(filterText)
    );

    switch (sortBy) {
        case 'date_asc':
            filtered.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            break;
        case 'rating_desc':
            filtered.sort((a, b) => b.rating - a.rating);
            break;
        case 'rating_asc':
            filtered.sort((a, b) => a.rating - b.rating);
            break;
        case 'date_desc': // Default
        default:
            filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            break;
    }

    displayReviews(filtered);
  }

  // --- Initial Load ---
  function loadAdminReviews() {
    // Fetch reviews from the same endpoint used by review1.html
    fetch("http://localhost:5000/reviews")
      .then(response => {
          if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
      })
      .then(data => {
          allReviews = data; // Store the fetched data
          filterAndSortReviews(); // Initial display (sorted by newest first)
      })
      .catch(error => {
          console.error("Error loading reviews:", error);
          reviewsContainer.innerHTML = '<p class="text-center text-danger py-4">Failed to load reviews. Please check the connection or try again later.</p>';
          reviewCountBadge.textContent = `Error`;
      });
  }

  // --- Event Listeners ---
  filterInput.addEventListener('input', filterAndSortReviews);
  sortSelect.addEventListener('change', filterAndSortReviews);

  // Load reviews when the admin page loads
  window.onload = loadAdminReviews;
</script>

</body>
</html>